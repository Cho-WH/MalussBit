# MalussBit micro:bit Firmware 구현 계획 (간소화 버전)

## 1. 목표 및 범위
- micro:bit v2, 서보모터, 온보드 조도 센서를 이용해 말루스 법칙 실험 데이터를 최소 구성으로 수집한다.
- MalussBit 웹앱(`js/bluetooth.js`)이 전송하는 명령에 따라 서보를 구동하고, 측정된 각도·조도 값을 UART 텍스트로 반환한다.
- 단순하고 신뢰성 높은 MakeCode JavaScript 펌웨어를 지향한다. 필수 기능 외 로직은 가능하면 제거하고, 꼭 필요한 확장만 선택 사항으로 명시한다.

## 2. 필수 기능
### 2.1 초기화
- 서보모터 구동 핀: P1 (PWM 출력), 조도 센서는 내장 `input.lightLevel()` 사용.
- `bluetooth.startUartService()` 호출 후 대기.
- 기본 변수 초기화: 현재 각도(`currentAngle`), 스윕 상태(`isSweeping`), 최근 명령 타임스탬프.

### 2.2 명령 수신 처리
- UART 개행 기준으로 한 줄씩 읽고 첫 토큰으로 분기.
- 지원 명령
  - `SWEEP,start_deg,end_deg,duration_ms`
    - 스윕 시작 시점(`sweepStartMs`), 시작/종료 각도 저장.
    - 스윕 상태를 활성화하고 목표 지속 시간 동안 각도 조작.
  - `STOP`
    - 스윕 상태를 즉시 종료하고 서보를 현재 위치에 유지(필요 시 시작 각도로 복귀).
- 그 외 명령은 무시.

### 2.3 서보 제어 루프
- 작성 필요

### 2.4 데이터 전송
- 스윕이 활성화된 동안 일정 주기(예: 50ms)마다 데이터 샘플 전송.
- 포맷: `timestamp_ms,angle_cmd,,light` (웹앱 파서가 angle_est 공백 허용).
- `timestamp_ms`는 `control.millis()` 기반.
- `light`는 `input.lightLevel()` 결과.

### 2.5 기본 안전 장치
- 각도 명령은 0–180° 범위로 제한.
- 블루투스 연결 종료 시 스윕 상태 리셋.


## 4. 구현 체크리스트
1. UART 서비스 및 이벤트 핸들러 생성.
2. 전역 상태 변수 정의(각도, 속도, 스윕시 각도).
3. `handleCommand` 함수 작성 (`SWEEP`, `STOP`, `CONFIG`).
4. `basic.forever` 루프에서 스윕 진행과 데이터 전송 처리.
5. 연결 끊김 이벤트에서 상태 초기화.
6. 실제 장비에서 `SWEEP`/`STOP`/데이터 포맷 검증.

## 5. 향후 확장 시 고려
- 선택 사항을 도입할 경우, 먼저 웹앱과 명령/응답 계약을 확정하고 필수 흐름에 영향이 없는지 확인한다.
- 신규 기능은 별도 플래그나 문서화로 관리하여 기본 빌드가 항상 최소 동작을 유지하도록 한다.
